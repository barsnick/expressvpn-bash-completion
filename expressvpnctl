#!/usr/bin/env bash

# Bash completion for expressvpnctl.

_expressvpnctl_regions() {
  local line
  expressvpnctl get regions 2>/dev/null | while IFS= read -r line; do
    [[ -n $line ]] && printf '%s\n' "$line"
  done
}

_expressvpnctl_complete_regions() {
  local cur=$1
  shift

  local match_cur=$cur
  local quoted=0
  local line
  local candidate
  local escaped
  local -a candidates=("$@")
  local -a matches=()

  if [[ $match_cur == \'* ]]; then
    quoted=1
    match_cur=${match_cur:1}
  elif [[ $match_cur == \"* ]]; then
    quoted=1
    match_cur=${match_cur:1}
  fi

  # Users may pre-escape shell metacharacters (e.g. foo-\(bar\)); match against raw values.
  match_cur=${match_cur//\\}

  while IFS= read -r line; do
    [[ -n $line ]] && candidates+=("$line")
  done < <(_expressvpnctl_regions)

  for candidate in "${candidates[@]}"; do
    [[ $candidate == "$match_cur"* ]] && matches+=("$candidate")
  done

  for candidate in "${matches[@]}"; do
    if ((quoted)); then
      COMPREPLY+=("$candidate")
    else
      printf -v escaped '%q' "$candidate"
      COMPREPLY+=("$escaped")
    fi
  done
}

_expressvpnctl() {
  local cur prev words cword
  _init_completion -s || return

  local options="--timeout -t --debug -d --help -h --version -v"
  local commands="background connect dedicatedip disconnect get install-chrome-extension install-firefox-extension login logout monitor resetsettings set status"

  local cmd=""
  local cmd_index=-1
  local i

  if [[ $prev == "--timeout" || $prev == "-t" ]]; then
    COMPREPLY=( $(compgen -W "5 10 15 30 60 120" -- "$cur") )
    return
  fi

  for ((i=1; i<${#words[@]}; i++)); do
    case "${words[i]}" in
      --timeout|-t)
        ((i++))
        continue
        ;;
      --timeout=*)
        continue
        ;;
      --debug|-d|--help|-h|--version|-v)
        continue
        ;;
      --)
        if (( i + 1 < ${#words[@]} )); then
          cmd=${words[i+1]}
          cmd_index=$((i + 1))
        fi
        break
        ;;
      -*)
        continue
        ;;
      *)
        cmd=${words[i]}
        cmd_index=$i
        break
        ;;
    esac
  done

  if [[ $cur == -* ]]; then
    COMPREPLY=( $(compgen -W "$options" -- "$cur") )
    return
  fi

  if [[ -z $cmd ]]; then
    COMPREPLY=( $(compgen -W "$commands" -- "$cur") )
    return
  fi

  if (( cword == cmd_index )); then
    COMPREPLY=( $(compgen -W "$commands" -- "$cur") )
    return
  fi

  case "$cmd" in
    background)
      if (( cword == cmd_index + 1 )); then
        COMPREPLY=( $(compgen -W "enable disable" -- "$cur") )
      fi
      ;;
    connect)
      if (( cword == cmd_index + 1 )); then
        _expressvpnctl_complete_regions "$cur" "smart"
      fi
      ;;
    dedicatedip)
      if (( cword == cmd_index + 1 )); then
        COMPREPLY=( $(compgen -W "status unlock ip" -- "$cur") )
      fi
      ;;
    get|monitor)
      if (( cword == cmd_index + 1 )); then
        local types="allowlan autoconnect blockAds blockAdult blockAll blockMalicious blockTrackers connectionstate debuglogging dnsconfigured networklock protocol pubip region regions smart split-app splittunnel vpnip"
        COMPREPLY=( $(compgen -W "$types" -- "$cur") )
      fi
      ;;
    login)
      if (( cword == cmd_index + 1 )); then
        _filedir
      fi
      ;;
    set)
      if (( cword == cmd_index + 1 )); then
        local types="allowlan autoconnect blockAds blockAdult blockAll blockMalicious blockTrackers debuglogging networklock protocol region split-app splittunnel"
        COMPREPLY=( $(compgen -W "$types" -- "$cur") )
        return
      fi

      if (( cword == cmd_index + 2 )); then
        local type=${words[cmd_index+1]}
        case "$type" in
          allowlan|autoconnect|blockAds|blockAdult|blockAll|blockMalicious|blockTrackers|debuglogging|networklock|splittunnel)
            COMPREPLY=( $(compgen -W "true false" -- "$cur") )
            ;;
          protocol)
            COMPREPLY=( $(compgen -W "auto lightwayudp lightwaytcp openvpnudp openvpntcp wireguard" -- "$cur") )
            ;;
          region)
            _expressvpnctl_complete_regions "$cur" "smart"
            ;;
          split-app)
            if [[ $cur == *:* ]]; then
              local prefix=${cur%%:*}
              local path=${cur#*:}
              local matches=()
              local file
              while IFS= read -r file; do
                matches+=("${prefix}:$file")
              done < <(compgen -f -- "$path")
              COMPREPLY=("${matches[@]}")
            else
              COMPREPLY=( $(compgen -W "bypass: vpn: remove:" -- "$cur") )
            fi
            ;;
        esac
      fi
      ;;
  esac
}

complete -F _expressvpnctl expressvpnctl
